---
title: "st2195_coursework"
author: "spence"
date: "2023-12-02"
output: html_document
---


===== this project will require tidyverse, data.table, DBI ===== 
```{r}
# checks if 'tidyverse' is NOT installed
if (!requireNamespace("tidyverse", quietly=TRUE)) {
  ## If so, install 'tidyverse' 
  install.packages("tidyverse")
}

# checks if 'data.table' is NOT installed
if (!requireNamespace("data.table", quietly=TRUE)) {
  ## If so, install 'data.table' 
  install.packages("data.table")
}

# checks if 'DBI' is NOT installed
if (!requireNamespace("DBI", quietly=TRUE)) {
  ## If so, install 'data.table' 
  install.packages("DBI")
}

# checks if 'RSQLite' is NOT installed
if (!requireNamespace("RSQLite", quietly=TRUE)) {
  ## If so, install 'RSQLite' 
  install.packages("RSQLite")
}

# loads the above packages if already installed or after installation
library(tidyverse)
library(data.table)
library(DBI)
library(RSQLite)
```


 ===== connecting to SQL DB ===== 
```{r}
# deleting r_coursework.db if it exists in wd
#if (file.exists("r_coursework.db")) {
#  file.remove("r_coursework.db")
#}

conn <- dbConnect(RSQLite::SQLite(), "r_coursework.db")
```


===== reading 1997 to 2007, planedata, airport and carrier csv =====
```{r}
# master table for all years
master <- data.table()

# listing of all years
years <- 1998:2007

# for loop in 'years" and read all years csv
for (year in years) {
  x <- paste0(year,".csv")
  year_data <- fread(x, header=TRUE)
  
  ## combining all years into single master for querying later
  master <- rbindlist(list(master, year_data))
}

# reading non-year csv
planes <- fread("plane-data.csv", header=TRUE, fill=TRUE)
airports <- fread("airports.csv", header=TRUE)
carriers <- fread("carriers.csv", header=TRUE)
```


===== descriptive statistics for all flight delay data =====
```{r}
# using summarise from dplyr in tidyverse

# consider ad for arrival delay
ad_stats <- master %>%
  summarise(
    mean_ad = mean(ArrDelay, na.rm = TRUE),
    median_ad = median(ArrDelay, na.rm = TRUE),
    sd_ad = sd(ArrDelay, na.rm = TRUE),
    max_ad = max(ArrDelay, na.rm = TRUE),
    min_ad = min(ArrDelay, na.rm = TRUE)
  )

# consider dd for departure delay
dd_stats <- master %>%
  summarise(
    mean_dd = mean(DepDelay, na.rm = TRUE),
    median_dd = median(DepDelay, na.rm = TRUE),
    sd_dd = sd(DepDelay, na.rm = TRUE),
    max_dd = max(DepDelay, na.rm = TRUE),
    min_dd = min(DepDelay, na.rm = TRUE)
  )

# consider td for total delay
td_stats <- master %>%
  summarise(
    mean_td = mean(ArrDelay + DepDelay, na.rm = TRUE),
    median_td = median(ArrDelay + DepDelay, na.rm = TRUE),
    sd_td = sd(ArrDelay + DepDelay, na.rm = TRUE),
    max_td = max(ArrDelay + DepDelay, na.rm = TRUE),
    min_td = min(ArrDelay + DepDelay, na.rm = TRUE)
  )

print(ad_stats)
print(dd_stats)
print(td_stats)
```


===== reading all data into SQL DB =====
```{r}
dbWriteTable(conn, "master", master, overwrite = TRUE)
dbWriteTable(conn, "planes", planes, overwrite = TRUE)
dbWriteTable(conn, "airports", airports, overwrite = TRUE)
dbWriteTable(conn, "carriers", carriers, overwrite = TRUE)
```


===== part 2 a: querying best times to minimise delay each year =====
```{r}
# update '2400' to '0000' in the db
 ## dbExecute(conn, "UPDATE master SET CRSDepTime = 0 WHERE CRSDepTime = 2400")

# querying out year, deptime(as time period) and depdelay+arrdelay
best_time_query <- "
  SELECT
    Year,
    CASE
      WHEN CRSDepTime BETWEEN 000 AND 559 THEN '0000-0559' 
      WHEN CRSDepTime BETWEEN 0600 AND 1159 THEN '0600-1159'
      WHEN CRSDepTime BETWEEN 1200 AND 1759 THEN '1200-1759'
      WHEN CRSDepTime BETWEEN 1800 AND 2359 THEN '1800-2359'
    END AS TimePeriod, 
    AVG(DepDelay + ArrDelay) AS Avg_Delay
  FROM
    master
  WHERE
    CRSDepTime <> 'NA' --removes cancelled flights
  GROUP BY
    Year, TimePeriod
"

# executing query
best_time <- dbGetQuery(conn, best_time_query)

print(best_time)
```


===== part 2 a: plot best times each year =====
```{r}
# turning column into factor
best_time$Year <- as.factor(best_time$Year)
best_time$TimePeriod <- factor(best_time$TimePeriod, levels = time_order)

# create a line plot
ggplot(best_time, aes(x = TimePeriod, y = Avg_Delay, group = Year, color = Year)) +
  geom_line() +
  geom_point() +
  labs(title = 'Average Delay by Time Period for each year',
       x = 'Time Period',
       y = 'Average Departure Delay') +
  scale_x_discrete(limits = time_order) +
  theme_minimal()
```


===== part 2 a: querying best days of week to minimise delay each year =====
```{r}
# querying out year, dayofweek and depdelay+arrdelay
best_day_query <- "
  SELECT
    Year,
    DayOfWeek,
    AVG(DepDelay + ArrDelay) AS Avg_Delay
  FROM
    Master
  WHERE
    CRSDepTime <> 'NA' --removes cancelled flights
  GROUP BY
    DayOfWeek, Year
  ORDER BY
    DayOfWeek ASC
"

# executing query
best_day <- dbGetQuery(conn, best_day_query)

print(best_day)
```


===== part 2 a: plot best days each year =====
```{r}
# plotting directly from the result of the query
best_day$Year <- as.factor(best_day$Year)
best_day$DayOfWeek <- as.factor(best_day$DayOfWeek)

# Create a line plot
ggplot(best_day, aes(x = DayOfWeek, y = Avg_Delay, group = Year, color = Year)) +
  geom_line() +
  geom_point() +
  labs(title = "Average Delay by Day of Week",
       x = "Day of Week",
       y = "Average Delay") +
  scale_x_discrete(labels = c("1" = "Sun", "2" = "Mon", "3" = "Tue", "4" = "Wed", "5" = "Thu", "6" = "Fri", "7" = "Sat")) +
  theme_minimal()
```


 part 2 b: do older planes suffer more delays on a year-to-year basis? =====
```{r}
plane_age_query <- "
  SELECT
    (Master.Year - planes.year) AS Age,
    Master.Year,
    Master.TailNum
  FROM
    Master
  LEFT JOIN planes
    ON Master.TailNum = planes.tailnum
  WHERE 
    (Master.Year - planes.year) >0 AND
    (Master.Year - planes.year) IS NOT NULL AND
    planes.year IS NOT NULL AND
    planes.year NOT LIKE 'None'
"

plane_age <- dbGetQuery(conn, plane_age_query)

print(plane_age)
```

# ===== part 2 c: logistic regression model for diverted flights =====
```{r}


```

# ===== disconnecting database =====
```{r}
dbDisconnect(conn)
```